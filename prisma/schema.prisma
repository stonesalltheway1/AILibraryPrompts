// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(cuid())
  clerkId      String     @unique
  email        String     @unique
  username     String     @unique
  displayName  String?
  avatarUrl    String?
  bio          String?
  reputation   Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  prompts      Prompt[]
  votes        Vote[]
  comments     Comment[]
  bookmarks    Bookmark[]
  
  // Marketplace relations
  sellerProfile   SellerProfile?
  purchases       Purchase[]
  productReviews  ProductReview[]
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  color       String?
  promptCount Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  prompts     Prompt[]
}

model AIModel {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  vendor      String
  description String?
  promptCount Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  prompts     Prompt[]
}

model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  
  prompts   Prompt[] @relation("PromptTags")
}

model Prompt {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String
  description String?
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)
  views       Int      @default(0)
  isFeatured  Boolean  @default(false)
  status      String   @default("published")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  
  modelId     String
  model       AIModel  @relation(fields: [modelId], references: [id])
  
  tags        Tag[]    @relation("PromptTags")
  votes       Vote[]
  comments    Comment[]
  bookmarks   Bookmark[]
  
  // Marketplace relation (optional - if prompt is also sold)
  marketplaceProducts MarketplaceProduct[]
  
  @@index([authorId])
  @@index([categoryId])
  @@index([modelId])
  @@index([createdAt])
  @@index([upvotes])
}

model Vote {
  id        String   @id @default(cuid())
  value     Int      // 1 for upvote, -1 for downvote
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  promptId  String
  prompt    Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
  
  @@unique([userId, promptId])
  @@index([promptId])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  promptId  String
  prompt    Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
  
  parentId  String?
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  
  @@index([promptId])
  @@index([userId])
}

model Bookmark {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  promptId  String
  prompt    Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
  
  @@unique([userId, promptId])
  @@index([userId])
}

// ============================================
// MARKETPLACE MODELS
// ============================================

model SellerProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  displayName     String
  bio             String?
  avatarUrl       String?
  paypalEmail     String    // For payouts
  
  totalEarnings   Float     @default(0)
  totalSales      Int       @default(0)
  rating          Float     @default(0)
  reviewCount     Int       @default(0)
  isVerified      Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  products        MarketplaceProduct[]
  payouts         Payout[]
}

model MarketplaceProduct {
  id              String    @id @default(cuid())
  
  sellerId        String
  seller          SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  
  promptId        String?   // Optional link to free prompt
  prompt          Prompt?   @relation(fields: [promptId], references: [id], onDelete: SetNull)
  
  title           String
  slug            String    @unique
  description     String
  content         String    // The actual prompt content (hidden until purchase)
  previewContent  String?   // Truncated preview
  usageInstructions String?
  
  price           Float
  currency        String    @default("USD")
  
  category        String
  modelType       String
  tags            String[]
  
  thumbnailUrl    String?
  
  salesCount      Int       @default(0)
  viewCount       Int       @default(0)
  rating          Float     @default(0)
  reviewCount     Int       @default(0)
  
  isFeatured      Boolean   @default(false)
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  purchases       Purchase[]
  reviews         ProductReview[]
  
  @@index([sellerId])
  @@index([category])
  @@index([price])
  @@index([isActive, isFeatured])
  @@index([createdAt])
}

model Purchase {
  id              String    @id @default(cuid())
  
  buyerId         String
  buyer           User      @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  
  productId       String
  product         MarketplaceProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  paypalOrderId   String    @unique
  paypalPayerId   String?
  
  amount          Float
  platformFee     Float     // 20% platform cut
  sellerAmount    Float     // 80% to seller
  currency        String    @default("USD")
  
  status          PurchaseStatus @default(PENDING)
  
  createdAt       DateTime  @default(now())
  completedAt     DateTime?
  
  @@index([buyerId])
  @@index([productId])
  @@index([status])
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  REFUNDED
  FAILED
}

model ProductReview {
  id              String    @id @default(cuid())
  
  productId       String
  product         MarketplaceProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  buyerId         String
  buyer           User      @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  
  rating          Int       // 1-5
  title           String?
  content         String?
  
  isVerified      Boolean   @default(true) // Verified purchase
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([productId, buyerId])
  @@index([productId])
}

model Payout {
  id              String    @id @default(cuid())
  
  sellerId        String
  seller          SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  
  amount          Float
  currency        String    @default("USD")
  paypalBatchId   String?
  
  status          PayoutStatus @default(PENDING)
  
  createdAt       DateTime  @default(now())
  processedAt     DateTime?
  
  @@index([sellerId])
  @@index([status])
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
